{% extends "base.html" %}
{% block title %}USER SPEECH BOARD{% endblock %}
{% block head %}

    {{super()}}
    <script language="JavaScript">


        // 엔터를 누르면 '추가' 버튼 클릭 트리거
        $(document).keypress(function(event) {
            var keycode = event.keyCode || event.which;
            if(keycode == '13') {
                $("#speech_add_btn_id").click();
            }
        });


        $(document).ready(function(){

            // ACT LIST 목록을 클릭하면
            $(".MyActList").click(function(){
                var act = $(this).text();

                $.ajax({
                   type:"POST",
                   url:"/ajax_find_by_act",
                   data:{'act' : act},
                   success:function(res){
                        var json_obj = JSON.parse(res);
                        var act = json_obj['act'];
                        var category = json_obj['category'];
                        var topic = json_obj['topic'];

                        $("#act_id").val(act);
                        $("#cat_id").val(category);
                        $("#top_id").val(topic);
                   },
                    error:function(error){
                       alert("ERROR : " + error);
                    }
                });
            });



            // '추가' 버튼을 클릭하면
            $("#speech_add_btn_id").click(function(){

                var act = $("#act_id").val();
                var category = $("#cat_id").val();
                var topic = $("#top_id").val();
                var user_speech = $.trim($("#us_id").val());


                if(act === ''){
                    $.notify("ACT LIST 에서 액트를 선택해주세요."
                        ,{
                            type:'danger',
                            delay:2000,
                            animate: {
                                    enter: 'animated bounceInDown',
                                    exit: 'animated hinge'
                            }
                        });
                }

                if(user_speech === ''){
                    $.notify("User Speech 를 입력해주세요."
                        ,{
                            type:'danger',
                            delay:2000,
                            animate: {
                                    enter: 'animated bounceInDown',
                                    exit: 'animated hinge'
                            }
                        });
                }

                // act와 user_speech 정보가 모두 입력이 되어 있다면
                else if(act !== '' && user_speech !== '') {
                    var is_slot_empty = 0;
                    var error_flag = 0;
                    var value_error_flag = 0;
                    var cnt = 0;

                    // slov-value 쌍 제대로 입력되어 있는지 확인
                    $(".MySV").children('div').children('input').each(function(){

                        var val = $.trim($(this).val());

                        // slot
                        if(cnt % 2 == 0){
                            if(val === ''){
                                is_slot_empty = 1;
                            }
                            else{
                                is_slot_empty = 0;
                            }
                        }

                        // value
                        else{
                            // slot은 값이 없는데 value가 값이 있는 경우
                            if(val !== '' && is_slot_empty === 1){
                                error_flag = 1;
                                // break의 역할
                                return false;
                            }
                            // slot에 값이 있는데 value가 비어있는 경우
                            else if(val === '' && is_slot_empty === 0){
                                error_flag = 1;
                                return false;
                            }
                            // slot, value 다 값이 있는데 value 가 user speech에 없는 단어인 경우
                            else if(val !== '' && is_slot_empty === 0){
                                if(user_speech.includes(val) === false){
                                    value_error_flag = 1;
                                    return false;
                                }
                            }
                        }


                        cnt += 1;
                    });


                    if(error_flag === 1){
                        $.notify("Slot : Value 를 다시 확인해주세요."
                        ,{
                            type:'danger',
                            delay:2000,
                            animate: {
                                    enter: 'animated bounceInDown',
                                    exit: 'animated hinge'
                            }
                        });
                    }
                    else if(value_error_flag === 1){
                        $.notify("Value 는 User Speech 에 있는 단어여야 합니다."
                        ,{
                            type:'danger',
                            delay:2000,
                            animate: {
                                    enter: 'animated bounceInDown',
                                    exit: 'animated hinge'
                            }
                        });
                    }
                    else {
                        cnt = 0;
                        var sv_pair_list = [];
                        var slot;

                        // slov-value 값 저장
                        $(".MySV").children('div').children('input').each(function () {

                            var temp_obj = {};

                            // 좌우 공백 제거
                            var val = $.trim($(this).val());

                            // 공백일땐 continue
                            if(val === ''){
                                // continue 역할
                                return true;
                            }

                            // slot
                            else if(cnt % 2 == 0){
                                slot = val;
                            }

                            // value
                            else{
                                temp_obj[slot] = val;
                                sv_pair_list.push(temp_obj);
                            }


                            cnt += 1;
                        });



                        $.ajax({
                            type:"POST",
                            url:"/ajax_add_speech",
                            data:{'act' : act, 'category' : category, 'topic' : topic, 'user_speech' : user_speech, 'slot_value' : JSON.stringify(sv_pair_list)},
                            success:function(res){
                                var json_obj = JSON.parse(res);
                                var id = json_obj['id'];
                                var act_count = json_obj['act_count'];
                                var rows_slot = json_obj['rows_slot'];

                                // ACT LIST 에 숫자 부분 증가
                                $("#act_list_id").find('a').each(function(){
                                    // 추가한 speech의 act를 찾는다.
                                    if($(this).text() === act){
                                        $(this).parent().parent().find('span').text(act_count);
                                    }
                                });

                                var slot_value_part = '';

                                if(sv_pair_list.length >= 1){
                                    slot_value_part += '<td class="text-center"><div style="border: 2px groove;">';
                                }
                                else{
                                    slot_value_part += '<td class="text-center"><div>';
                                }

                                var i, key;
                                for(i = 0 ; i < sv_pair_list.length ; i++){
                                    for(key in sv_pair_list[i]){
                                        slot_value_part += key + ' : ' + sv_pair_list[i][key] + '<br>';
                                    }
                                }
                                slot_value_part += '</div></td>';

                                // speech board 테이블에 추가
                                $("#speech_board_id").prepend('<tr class="table-success"><td class="text-center">' + id + '</td><td class="text-center">' + user_speech + '</td><td class="text-center">' + category + '</td><td class="text-center">' + topic + '</td><td class="text-center">' + act + '</td>' + slot_value_part + '<td class="text-center"><input type="button" class="btn btn-danger btn-sm" onclick="trigger_modal(' + id + ')" value="삭제"></td>');

                                $(".container-fluid").append(
                                    '        <div id="myModal' + id + '" class="modal fade" role="dialog">\n' +
                                    '            <div class="modal-dialog" style="width:30%">\n' +
                                    '                <div class="modal-content">\n' +
                                    '                    <div class="modal-header">\n' +
                                    '                        <h4 class="modal-title"><i class="fas fa-exclamation-triangle"></i>경고</h4>\n' +
                                    '                        <button type="button" class="close" data-dismiss="modal">&times;</button>\n' +
                                    '                    </div>\n' +
                                    '\n' +
                                    '                    <div class="modal-body">\n' +
                                    '                        <p>' + id + '번 발화문을 정말 삭제하시겠습니까?</p>\n' +
                                    '                    </div>\n' +
                                    '\n' +
                                    '                    <div class="modal-footer">\n' +
                                    '                        <button type="button" class="btn btn-danger mr-auto" data-dismiss="modal">아니오</button>\n' +
                                    '                        <form class="MyFormClass">\n' +
                                    '                            <input type="submit" class="btn btn-primary" data-dismiss="modal" value="예" onclick="modal_yes('+ id +');">\n' +
                                    '                            <input type="hidden" name="table_name" value="speech">\n' +
                                    '                        </form>\n' +
                                    '                    </div>\n' +
                                    '                </div>\n' +
                                    '            </div>\n' +
                                    '        </div>');




                                $.notify("User Speech 가 추가되었습니다."
                                    , {
                                        type: 'success',
                                        delay: 2000,
                                        animate: {
                                            enter: 'animated bounceInDown',
                                            exit: 'animated hinge'
                                        }
                                });


                                // 추가하고 나면 user speech 랑 slot value 칸 비워준다.
                                $("#us_id").val("");
                                // slot value의 모든 자식 요소 삭제하고
                                $(".MySV").children('div').remove();


                                var slot_list_part = '<datalist id="slot_list">';
                                for(var i in rows_slot){
                                    slot_list_part += '<option value=' + rows_slot[i]['slot'] + '>';
                                }
                                slot_list_part += '</datalist>';


                                // 하나만 새로 추가
                                $(".MySV").append('<div><input list="slot_list" class="form-control mt-1" value="">' + slot_list_part + ' : <input type="text" class="form-control" value=""> <button class="btn btn-success" type="button" onclick="sv_add();"><i class="fas fa-plus"></i></button> <button class="btn btn-warning" type="button"><i class="fas fa-minus"></i></button></div>');

                            },
                            error:function(error){
                                alert('ERROR : ' + error);
                            }
                        });

                    }

                }

            });



        });



        function trigger_modal(id){
            alert(id);
            //$("#myModal" + id).find('input[name=speech_id]').val(id);
            $("#myModal" + id).modal();
        }



        function order_text(id){
            // 1 이면 오름차순 정렬
            // 0 이면 내림차순 정렬
            var url = $(location).attr('href');
            var asc1_desc0 = getParameterByName(url, 'asc1_desc0');
            var search_msg = getParameterByName(url, 'search_msg');
            var article_id = getParameterByName(url, 'article_id');
            var inc_num = getParameterByName(url, 'inc_num');
            var before_selected_col = getParameterByName(url, 'col_name');
            var ordering = 1;

            if(id == before_selected_col){
                if(asc1_desc0 == 1) {
                    ordering = 0;
                }
                else {
                    ordering = 1;
                }
            }
            else {
                ordering = 1;
            }


            // 검색한 경우 ordering
            if(search_msg){
                if(inc_num){
                    location.replace("/" + 'text_board' + "/order?article_id=" + article_id + "&col_name=" + id + "&asc1_desc0=" + ordering + "&search_msg=" + search_msg + "&inc_num=" + inc_num);
                }
                else{
                    location.replace("/" + 'text_board' + "/order?article_id=" + article_id + "&col_name=" + id + "&asc1_desc0=" + ordering + "&search_msg=" + search_msg);
                }
            }
            // 검색하지 않았을 경우 ordering
            else{
                if(inc_num){
                    location.replace("/" + 'text_board' + "/order?article_id=" + article_id + "&col_name=" + id + "&asc1_desc0=" + ordering + "&inc_num=" + inc_num);
                }
                else{
                    location.replace("/" + 'text_board' + "/order?article_id=" + article_id + "&col_name=" + id + "&asc1_desc0=" + ordering);
                }

            }


        }

        function search_text(){
            var search_msg = $("#SearchText").val().trim();

            if(search_msg == ''){
                alert('검색어를 입력해주십시오.');
            }
            else{
                $("#frm").attr("method", "get");
                $("#frm").attr("action", "/text_board/search");
                $("#frm").submit();
            }

        }


        function getParameterByName(url, param_name){
            var after_part = url.split("?")[1];
            var param_arr = after_part.split("&");

            for(var i = 0 ; i < param_arr.length ; i++)
            {
                var key_value = param_arr[i].split("=");

                if(key_value[0] === param_name)
                {
                    return key_value[1];
                }
            }
        }

        // slot_value 칸 추가 함수
        function sv_add(){

            // hidden input에 있는 slot테이블의 json스트링 데이터를 받아온다.
            var rows_slot = $("#rows_slot_jsonstr_id").val();

            // json오브젝트 형식으로 변환
            var rows_slot_parsed = JSON.parse(rows_slot);

            var slot_list_part = '<datalist id="slot_list">';
            for(var i in rows_slot_parsed){
                slot_list_part += '<option value=' + rows_slot_parsed[i]['slot'] + '>';
            }
            slot_list_part += '</datalist>';

            $(".MySV").append('<div><input list="slot_list" class="form-control mt-1" value="">' + slot_list_part + ' : <input type="text" class="form-control" value=""> <button class="btn btn-success" type="button" onclick="sv_add();"><i class="fas fa-plus"></i></button> <button class="btn btn-warning" type="button" onclick="$(this).parent().remove();"><i class="fas fa-minus"></i></button></div>');
        }



        function modal_yes(id){
            $(".MyFormClass").attr("method", "post");
            $(".MyFormClass").attr("action", "/user_speech_board/delete/" + id);
            $(".MyFormClass").submit();
        }


        function reset_all(){
            $("#act_id").val("");
            $("#cat_id").val("");
            $("#top_id").val("");
            $("#us_id").val("");

            // slot value의 모든 자식 요소 삭제하고
            $(".MySV").children('div').remove();

            // slot_value 칸 하나 추가
            sv_add();

            // 첫 slot_value 칸은 삭제되면 안되므로 '-' 버튼의 onclick 이벤트 제거
            $(".MySV").find('.btn-warning').removeAttr('onclick');
        }

    </script>


{% endblock %}


{% block nav %}
<ul class="navbar-nav">
    <li class="nav-item">
        <a class="nav-link" href="{{url_for('act_manager')}}">Act Manager</a>
    </li>

    <li class="nav-item active">
        <a class="nav-link" href="{{url_for('text_board', col_name='sent_id', asc1_desc0=1)}}">User Speech Board</a>
    </li>

    <li class="nav-item">
        <a class="nav-link" href="{{url_for('export')}}">Export</a>
    </li>
</ul>

<ul class="navbar-nav ml-auto">
    <li class="nav-item"><a class="nav-link" href="#">{{user_id}}님 접속중...</a></li>
    <li class="nav-item"><a class="nav-link" href="{{url_for('logout')}}"><i class="fa-blink"><i class="fas fa-sign-out-alt"></i></i> 로그아웃</a></li>
</ul>
{% endblock %}


{% block content %}

<!-- 서버측에서 전송해준 slot 테이블의 json스트링 데이터 -->
<input type="hidden" id="rows_slot_jsonstr_id" value="{{rows_slot_jsonstr}}">


    <div class="container-fluid">


        <div class="row">
            <form class="form-inline my-2" id="frm" role="search">
                <div class="col-md-10">
                    <div class="form-group">
                        <input type="text" class="form-control col-md-12" id="SearchText" name="search_msg" placeholder="문장을 검색해주세요." disabled>
                    </div>
                </div>

                <div class="form-group">
                    <input type="submit" class="btn btn-primary" onclick="search_text()" value="검색">
                </div>
            </form>
        </div>


        <div class="row">

            <div class="col-2">
                {% include 'act_list.html' ignore missing %}
            </div>


            <div class="col">

                <div class="card border-dark my-2">
                    <form id="speech_add_frm_id">
                        <div class="row">
                            <div class="col">
                                <div class="form-inline">

                                    <div class="card-body">
                                            <div class="card-title font-weight-bold">Act</div>

                                            <div clsas="card-text">
                                                <div class="col font-weight-bold">
                                                    <input type="text" class="form-control" id="act_id" placeholder="ACT LIST에서 선택" disabled>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="card-body">
                                        <div class="card-title font-weight-bold">Category</div>

                                        <div clsas="card-text">
                                            <div class="col font-weight-bold">
                                                <input type="text" class="form-control" id="cat_id" placeholder="" disabled>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card-body">
                                            <div class="card-title font-weight-bold">Topic</div>

                                            <div clsas="card-text">
                                                <div class="col font-weight-bold">
                                                    <input type="text" class="form-control" id="top_id" placeholder="" disabled>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="form-inline">
                                    <div class="card-body" style="width:38rem">
                                        <div class="card-title font-weight-bold">User Speech</div>

                                        <div clsas="card-text">
                                            <div class="col-xl-12">
                                                <div class="input-group font-weight-bold">
                                                    <input type="text" class="form-control" id="us_id" placeholder="예상 발화문 입력" value="">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-inline">
                                    <div class="card-body col-8">
                                        <div class="card-title font-weight-bold">Slot : Value</div>

                                        <div clsas="card-text">
                                            <div class="col font-weight-bold MySV">
                                                <div>
                                                    <input list="slot_list" class="form-control" value="">
                                                    <datalist id="slot_list">
                                                    {% for row_slot in rows_slot %}
                                                        <option value="{{row_slot.slot}}">
                                                    {% endfor %}
                                                    </datalist>
                                                    :
                                                    <input type="text" class="form-control" value="">

                                                    <button class="btn btn-success" type="button" onclick="sv_add();"><i class="fas fa-plus"></i></button>
                                                    <button class="btn btn-warning" type="button"><i class="fas fa-minus"></i></button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-2">

                                <div class="flex-row" style="height:80%">
                                    <input type="button" class="btn btn-block btn-primary font-weight-bold" id="speech_add_btn_id" style="height:100%" value="추가">
                                </div>

                                <div class="flex-row" style="height:20%">
                                    <input type="button" class="btn btn-block btn-danger font-weight-bold" id="" value="초기화" style="height:100%" onclick="reset_all()">
                                </div>

                            </div>
                        </div>



                    </form>
                </div>

                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <div>
                                {% set cname_1 = 'fas fa-sort' %}
                                {% if asc1_desc0 == '0' and col_name == 'sent_id' %}
                                    {% set cname_1 = 'fas fa-sort-down' %}
                                {% elif asc1_desc0 == '1' and col_name == 'sent_id' %}
                                    {% set cname_1 = 'fas fa-sort-up' %}
                                {% else %}
                                    {% set cname_1 = 'fas fa-sort' %}
                                {% endif %}
                                </div>
                                <th style="width : 7%" class="text-center">ID<button class="btn" id="sent_id" onclick="order_text(id)"><i class='{{cname_1}}'></i></button></th>
                                <th class="text-center">User Speech</th>
                                <th style="width : 11%" class="text-center">Category</th>
                                <th style="width : 15%" class="text-center">Topic</th>
                                <th style="width : 15%" class="text-center">Act</th>
                                <th style="width : 20%" class="text-center">Slot : Value</th>
                                <th></th>
                            </tr>
                        </thead>

                        <tbody id="speech_board_id">
                        {% for row in board_total %}
                            <tr>
                                <td class="text-center">{{row.id}}</td>
                                <td class="text-center">{{row.speech}}</td>
                                <td class="text-center">{{row.category}}</td>
                                <td class="text-center">{{row.topic}}</td>
                                <td class="text-center">{{row.act}}</td>
                                <td class="text-center">
                                    <!-- slot_value 쌍이 존재하는 경우 -->
                                    {% if row.slot_value | length >= 1 %}
                                        <div style="border: 2px groove;">
                                            {% for each_dict in row.slot_value %}
                                            {% for key, value in each_dict.items() %}
                                                {{key}} : {{value}}
                                                <br>
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                    <!-- slot_value 쌍이 존재하지 않는 경우 -->
                                    {% else %}
                                        <div>
                                            {% for each_dict in row.slot_value %}
                                            {% for key, value in each_dict.items() %}
                                                {{key}} : {{value}}
                                                <br>
                                            {% endfor %}
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </td>


                                <td class="text-center">
                                    <input type="button" class="btn btn-danger btn-sm" onclick="trigger_modal('{{row.id}}')" value="삭제">
                                </td>

                            </tr>
                        {% endfor %}

                        </tbody>
                    </table>


            </div>
        </div>



        {% for row in board_total %}
        <!-- Modal -->
        <div id="myModal{{row.id}}" class="modal fade" role="dialog">
            <div class="modal-dialog" style="width:30%">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title"><i class="fas fa-exclamation-triangle"></i>경고</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <div class="modal-body">
                        <p>{{row.id}}번 발화문을 정말 삭제하시겠습니까?</p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger mr-auto" data-dismiss="modal">아니오</button>
                        <form class="MyFormClass">
                            <input type="submit" class="btn btn-primary" data-dismiss="modal" value="예" onclick="modal_yes('{{row.id}}');">
                            <!--<input type="hidden" name="speech_id" value="{{row.id}}">-->
                            <input type="hidden" name="table_name" value="speech">
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}

        <a id="back-to-top" href="#" class="btn btn-primary btn-lg back-to-top" role="button" title="Click to return on the top page" data-toggle="tooltip" data-placement="left"><i class="fas fa-arrow-circle-up fa-2x"></i></a>

    </div>
{% endblock %}
